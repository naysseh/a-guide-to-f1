<!DOCTYPE html>
<html>

<head>
  <title>A Guide To F1</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-geo-projection@4"></script>
  <script src="scripts/createDropLine.js"></script>

  <link rel="icon" type="image/x-icon" href="/images/f1.png">

  <link rel="stylesheet" type="text/css" href="styles/site.css">
</head>


<body>
  <div id="intro">
    <div id="title-descr">
      <img id="main-logo" src="images/logo-red.png" alt="A Guide to Formula 1" width="500px">
      <img id="descr" src="images/description-1.png" alt="An introductory guide to the high-speed motorsport"
        width="300px">
    </div>

    <!-- Image sourced from https://www.clipartmax.com/middle/m2K9A0m2G6m2Z5N4_free-vector-formula-one-car-clip-art-formula-1-clipart/ -->
    <img src="images/final-car.png" alt="Red Formula 1 car clipart" width="700px">
  </div>

  <div class="scroll-bounce">
    <p>SCROLL TO CONTINUE</p>
  </div>

  <div id="car-info">
    <div id="infoAnnotations">
      <img src="images/the-cars.png" alt="The Cars" width="300px" class="imgTitle">

      <div id="car-description">
        The F1 car is the driver's sole tool during a race. During an average race, a driver is seated in the vehicle
        for around 70 laps or 1.5 hours. Drivers, via controls on their steering wheel, can speak directly to their
        teams and engineers to get status updates, change the brake balance, shift gears, decrease to pit lane speed,
        and more.
        <br><br>
        With speeds up to around 220mph, there is a heavy amount of engineering that goes into managing airflow around
        the vehicle to keep it gliding over the ground. Each component of the car must be purposeful&#8212internal and
        external&#8212to achieve maximum speed and reliability.
        <br><br>
        <em><strong>Mouse over</strong> the areas on the car to learn more about them.</em>
      </div>
    </div>

    <div id="car-and-points">
      <div class="car-popup" id="circle-1-div">
        <p>Tires</p>
        <p>F1 tires are supplied by Pirelli. Teams are able to change tires multiple times per weekend, but can only
          choose from a predetermined selection of soft, medium, and hard compound tires. This selection also includes
          rain (wets) and other treaded tires (intermediates) in the case of poor weather.</p>
      </div>

      <span class="circle" id="circle-1"></span>

      <div class="car-popup" id="circle-2-div">
        <p>Front Wing</p>
        <p>The car's front wing is the first line of defense in creating proper airflow around the vehicle, allowing it
          to go quicker. Because of their high speed, F1 cars are at high risk of flipping or spinning out, especially
          around corners. The front wing (in part) helps to produce downforce which keeps the car on the ground.</p>
      </div>

      <span class="circle" id="circle-2"></span>

      <div class="car-popup" id="circle-3-div">
        <p>Cockpit</p>
        <p>Seats are individually molded to fit the body of each driver to give maximum comfort and flexibility to read
          the pedals and control the wheel. Drivers can be seated here for up to 2 hours straight during the race. The
          cockpit is typically surrounded by a rounded bar, called the halo, for safety purposes.</p>
      </div>

      <span class="circle" id="circle-3"></span>

      <div class="car-popup" id="circle-4-div">
        <p>Sidepod</p>
        <p>The sidepod is another important portion of the car that can affect drag and help to manage proper
          aerodynamics. It holds various internal components of the car, such as the radiators, which are integral in
          cooling off the engine to maintain a driveable temperature.</p>
      </div>

      <span class="circle" id="circle-4"></span>

      <div class="car-popup" id="circle-5-div">
        <p>Rear Wing</p>
        <p>Similar to the front wing, this component plays another important role in creating downforce and managing
          airflow. It allows for air to go above and below to create additional downforce, or through a remotely
          openable flap to reduce drag during long straight portions of the circuits. </p>
      </div>

      <span class="circle" id="circle-5"></span>
      <!-- <span class="circle" id="circle-6"></span> -->
      <!-- Image sourced from https://www.clipartmax.com/middle/m2K9A0m2G6m2Z5N4_free-vector-formula-one-car-clip-art-formula-1-clipart/ -->
      <img src="images/final-car.png" alt="Red Formula 1 car clipart" width="800px">
    </div>
  </div>

  <div class="scroll-bounce">
    <p>SCROLL TO CONTINUE</p>
  </div>

  <div id="map">
    <div id="mapAnnotations">
      <img src="images/the-tracks.png" alt="The Tracks" width="300px" class="imgTitle">

      <div id="mapText">What is F1? The fast paced motorsport, <strong>Formula 1</strong>, has been around since 1950.
        With historical top speeds of around 180 mph in 1950, and current top speeds at around 220 mph, the F1 car is
        not your average roadster. Cheetahs can run at up to 80 mph; the average car can likely hit 120. F1 cars are the
        fastest in the world, making the sport high energy, fast paced, and dangerous.
        <br><br>
        Note that not all displayed circuits are active. Currently active circuits for the 2023 season are highlighted.
        <br><br>
        <em><strong>Click</strong> on a point to view information about that circuit.</em>
      </div>

      <div id="mapPopup">
        <div>
          <h3 class="popupTitle">CIRCUIT INFO:</h3>
          <text id="circuitName"></text>
          <br>
          <text id="circuitLocation"></text>
          <br>
          <text id="active-yes"></text>
        </div>

        <div class="flagDiv">
          <img id="teamCountry" src="" alt="">
        </div>
      </div>

      <button class="next-button" id="next1" onclick="next1()">View Next &#9660;</button>
    </div>

    <svg id="map" height="700" width="900"></svg>
  </div>

  <div class="bar-chart-area" id="barChartArea">
    <div id="barchartAnnotations">
      <img src="images/the-teams.png" alt="The Teams" width="300px" class="imgTitle">

      <div class="bar-desc">
        <span id="barDescText"> <em><strong>Click</strong> on a circuit on the map above to begin.</em><br><br></span>
        Let's now look at historical win counts for teams. Throughout F1's history, there have been
        teams who consistently dominate: Williams, Ferrari, McLaren, Mercedes, and currently Red Bull.
        <br><br>Here we can analyze which teams have dominated based on the circuit. Does their success depend on a
        circuit? It's likely that a team dominates overall, especially with a reliable car, to be successful for an
        entire season.<br><br>
        Which teams are the top winners for the <span id="circuitBlank">_____</span> race? <br>
        <br>

        <button class="next-button" id="next2" onclick="next2()">View Next &#9660;</button>
      </div>
    </div>

    <svg id="barChart" height="500" width="800"></svg>
  </div>

  <div id="lineChartArea">
    <div id="linechartAnnotations">

      <img src="images/the-speed.png" alt="The Speed" width="300px" class="imgTitle">

      <div id="lineText">
        <span id="line-temp"><em><strong>Click</strong> on a circuit on the map above to view times.</em><br><br></span>
        How have lap times changed per race? Check out previous stats from the <text id="lineBlank">_____</text> race.
        <br><br> <text id="lineEmpty">Here, we see the fastest lap times from that race for a certain year.
          Lap times are affected by a number of factors: tire type, fuel level,
          overall car build, track temperature, weather conditions, and other factors.</text> <br>

        <button class="next-button" id="next3" onclick="next3()">View Next &#9660;</button>
      </div>
    </div>

    <svg id="lineChart" height="500" width="800"></svg>
  </div>

  <div id="scatterArea">
    <div id="scatterAnnotations">
      <img src="images/the-drivers.png" alt="The Drivers" width="300px" class="imgTitle">

      <div id="scatterText">Does length of career correlate with success in F1? Yes, but not necessarily. A few notable
        drivers such as Lewis Hamilton, Alain Prost, and Ayrton Senna have scored big in their careers, despite none of
        them having been driving the longest.
        <br><br>
        <em><strong>Hover</strong> over a point to view more information about that driver.</em>

      </div>

      <div id="driverYearStats">
        <div>
          <h3 class="popupTitle">DRIVER INFO</h3>
          <text>Driver:</text>
          <text id="driverName"></text>
          <br>
          <text>Career length:</text>
          <text id="driverYears"></text>
          <br>
          <text>Win count:</text>
          <text id="driverWins"></text>
        </div>
        <div class="flagDiv">
          <img id="nationality" src="" alt="">
        </div>
      </div>


      <button class="next-button" id="top" onclick="topScroll()">Back to Top &#9650;</button>
    </div>
    <svg id="scatter" height="500" width="700"></svg>
  </div>


  <script>
    // formatting for map
    const map = d3.select("svg#map");
    const mapHeight = map.attr("height");
    const mapWidth = map.attr("width");
    let circuitName = d3.select("text#circuitName");
    let circuitLocation = d3.select("text#circuitLocation");

    // formatting for bar chart
    const barChart = d3.select("svg#barChart");
    const barHeight = barChart.attr("height");
    const barWidth = barChart.attr("width");
    const barMargins = { top: 10, right: 20, bottom: 30, left: 20 };
    const barChartHeight = barHeight - barMargins.top - barMargins.bottom
    const barChartWidth = barWidth - barMargins.right - barMargins.left
    let barAnnotations = barChart.append("g").attr("id", "bar-annotations");
    let barChartArea = barChart.append("g")
      .attr("transform", "translate(" + barMargins.left + "," + barMargins.top + ")")
      .attr("class", "barChartBackground");

    // formatting for line chart
    const lineChart = d3.select("svg#lineChart");
    const lineHeight = lineChart.attr("height");
    const lineWidth = lineChart.attr("width");
    const lineMargins = { top: 10, right: 50, bottom: 30, left: 50 };
    const lineGraphHeight = lineHeight - lineMargins.top - lineMargins.bottom
    const lineGraphWidth = lineWidth - lineMargins.right - lineMargins.left
    let lineAnnotations = lineChart.append("g").attr("id", "line-annotations");
    let lineChartArea = lineChart.append("g")
      .attr("transform", "translate(" + lineMargins.left + "," + lineMargins.top + ")")
      .attr("class", "lineChartBackground");

    let xScaleLine = d3.scaleLinear().range([0, lineGraphWidth]);
    let yScaleLine = d3.scaleLinear().range([lineGraphHeight, 0]);

    let leftAxisLine = d3.axisLeft(yScaleLine)
      .tickFormat("")
      .tickSize(-lineGraphWidth - 10);
    let leftGridlinesLine = d3.axisLeft(yScaleLine)
      .tickFormat(function (d) {
        return Math.round((d / 1000) / 60) + " min " + +((d / 1000) % 60).toFixed(1) + " sec"
      });
    lineChartArea.append("g")
      .attr("class", "yAxisLine y axis")
      .attr("transform", `translate(${lineMargins.left},${lineMargins.top})`)
      .call(leftAxisLine)
    lineChartArea.append("g")
      .attr("class", "yGridLine y gridlines")
      .attr("transform", `translate(${lineMargins.left},${lineMargins.top})`)
      .call(leftGridlinesLine);

    let bottomAxisLine = d3.axisBottom(xScaleLine)
      .tickFormat('')
      .tickSize(-lineGraphHeight);
    let bottomGridlinesLine = d3.axisBottom(xScaleLine)
      .tickFormat(d3.format("d"))
    lineChartArea.append("g")
      .attr('class', 'xAxisLine x axis')
      .attr('transform', `translate(${lineMargins.left},${lineGraphHeight + lineMargins.top})`)
      .call(bottomAxisLine);
    lineChartArea.append("g")
      .attr('class', 'xGridLine x gridlines')
      .attr('transform', `translate(${lineMargins.left},${lineGraphHeight + lineMargins.top})`)
      .call(bottomGridlinesLine);
    // end formatting for line chart

    // scatter plot formatting
    const scatter = d3.select("svg#scatter");
    const scatterHeight = scatter.attr("height");
    const scatterWidth = scatter.attr("width");
    const scatterMargins = { top: 15, right: 10, bottom: 20, left: 25 };
    let scatterArea = scatter.append("g")
      .attr('transform', `translate(${scatterMargins.left},${0})`);
    let scatterHeightA = scatterHeight - scatterMargins.top - scatterMargins.bottom;
    let scatterWidthA = scatterWidth - scatterMargins.left - scatterMargins.right;

    // The Car section
    let circle1div = document.getElementById("circle-1-div");
    let circle1 = d3.select("span#circle-1");
    circle1.on("mouseover", function (e) {
      circle1div.style.visibility = "visible";
    })
      .on("mouseout", function (e) {
        circle1div.style.visibility = "hidden";
      })
    let circle2div = document.getElementById("circle-2-div");
    let circle2 = d3.select("span#circle-2");
    circle2.on("mouseover", function (e) {
      circle2div.style.visibility = "visible";
    })
      .on("mouseout", function (e) {
        circle2div.style.visibility = "hidden";
      })
    let circle3div = document.getElementById("circle-3-div");
    let circle3 = d3.select("span#circle-3");
    circle3.on("mouseover", function (e) {
      circle3div.style.visibility = "visible";
    })
      .on("mouseout", function (e) {
        circle3div.style.visibility = "hidden";
      })
    let circle4div = document.getElementById("circle-4-div");
    let circle4 = d3.select("span#circle-4");
    circle4.on("mouseover", function (e) {
      circle4div.style.visibility = "visible";
    })
      .on("mouseout", function (e) {
        circle4div.style.visibility = "hidden";
      })
    let circle5div = document.getElementById("circle-5-div");
    let circle5 = d3.select("span#circle-5");
    circle5.on("mouseover", function (e) {
      circle5div.style.visibility = "visible";
    })
      .on("mouseout", function (e) {
        circle5div.style.visibility = "hidden";
      })


    // End - the car section

    /*
      The data files setup (by Natasha) <3 
  
      The ones inside the /data/kaggle_data/ folder are all the original, unchanged files from Kaggle.
      
      Then the files that were made by preprocessing in Jupyter, stored in data/edited_data/:
  
      first_place_instances.csv: Is the same as the above one but only has a result if the result was first place (I made this specifically for the scatterplot)

      wins_and_years.csv: total years driven and total wins for a driver

      races_fastest_times.csv: fastest lap times for each race
    */

    const requestData = async function () {

      const atlasData = await d3.json("data/world-countries.json");

      const winsYears = await d3.csv("data/edited_data/wins_and_years.csv", d3.autoType);

      const constructorData = await d3.csv("data/kaggle_data/constructors.csv", d3.autoType);

      const winData = await d3.csv("data/edited_data/first_place_instances.csv", d3.autoType);

      const driverData = await d3.csv("data/kaggle_data/drivers.csv", d3.autoType);

      const nationalityConvert = await d3.csv("data/countries_nationality.csv", d3.autoType);

      // This CSV has all the info about every previous circuit, some of which are not currently active but all should have data from the past [this is literally just the list of circuits, not connected w anything else]
      const circuits = await d3.csv("data/kaggle_data/circuits.csv", d3.autoType);

      // This CSV has all the info about every RACE, meaning every race from every year (not just information about the circuit itself, like in circuits.csv)
      const races = await d3.csv("data/kaggle_data/races.csv", d3.autoType);

      const fastestLaps = await d3.csv("data/edited_data/races_fastest_times.csv", d3.autoType);

      racesNcircuits = {}
      races.forEach(d => {
        cId = d.circuitId;
        rId = d.raceId;
        if (!(cId in racesNcircuits)) {
          racesNcircuits[cId] = [rId];
        } else if (cId in racesNcircuits) {
          raceList = racesNcircuits[cId]
          raceList.indexOf(rId) === -1 ? raceList.push(rId) : console.log("This item already exists");
          racesNcircuits[cId] = raceList;
        }
      })

      let viewport = map.append("g");
      let countryMesh = topojson.mesh(atlasData, atlasData.objects.countries1);
      let countries = topojson.feature(atlasData, atlasData.objects.countries1);

      var projection = d3.geoNaturalEarth2().fitSize([mapWidth, mapHeight], countries);
      var path = d3.geoPath().projection(projection);

      viewport.selectAll("path.country")
        .data(countries.features)
        .join("path")
        .attr("class", "country")
        .style("fill", "none")
        .style("stroke", "white")
        .style("stroke-width", ".5px")
        .attr("d", path);

      var zoom = d3.zoom()
        .scaleExtent([1, 10])
        .on("zoom", zoomTransform);

      // Function: generate line chart based on given lap times
      function generateLineChart(dictYearLapTime) {
        document.getElementById("line-temp").textContent = "";
        const transitionTime = Object.keys(dictYearLapTime).length == 0 ? 0 : 3000
        document.getElementById("lineEmpty").textContent = Object.keys(dictYearLapTime).length == 0 ?
          "Here, the circuit does not have fastest lap times reported." : "Here, we see the fastest lap times from that race for a certain year. \
        Lap times are affected by a number of factors: tire type, fuel level, \
        overall car build, track temperature, weather conditions, and other factors.";
        dataDict = [];
        const toMilli = (min, sec) => (min * 60 + sec) * 1000;

        Object.keys(dictYearLapTime).forEach(function (key, index) {
          newKey = Number(key)
          val = dictYearLapTime[key];
          splited = val.split(":")
          dataDict[newKey] = toMilli(Number(splited[0]), Number(splited[1]))
        });

        var keys = Object.keys(dataDict);
        var values = []
        keys.forEach((key) => {
          values.push(dataDict[key]);
        });

        let yearsExtent = d3.extent(keys)
        let timeExtent = d3.extent(values)

        xScaleLine.domain([yearsExtent[0], Number(yearsExtent[1]) + .9]);
        yScaleLine.domain([timeExtent[0] - 1000, timeExtent[1] + 1000]);

        lineChartArea.selectAll(".xAxisLine").transition()
          .duration(transitionTime)
          .call(bottomAxisLine);
        lineChartArea.selectAll(".xGridLine").transition()
          .duration(transitionTime)
          .call(bottomGridlinesLine);

        lineChartArea.selectAll(".yAxisLine").transition()
          .duration(transitionTime)
          .call(leftAxisLine);
        lineChartArea.selectAll(".yGridLine").transition()
          .duration(transitionTime)
          .call(leftGridlinesLine);

        var lineGen = d3.line()
          .x(d => xScaleLine(d))
          .y(d => yScaleLine(dataDict[d]) + 10)

        const line = lineChartArea.selectAll(".lineSpeed")
          .data([keys], function (d) { return d });

        line
          .join("path")
          .attr("class", "lineSpeed")
          .attr("transform", `translate(${lineMargins.left})`)
          .transition()
          .duration(transitionTime)
          .attr("d", lineGen)
          .attr("fill", "none")
          .attr("stroke", "#c70c0c")
          .attr("stroke-width", 3);

        let activeArea = lineChartArea.append("g");
        let dropLine = activeArea.append("line")
          .attr("id", "dropLine")
          .attr("fill", "none")
          .attr("stroke", "white")
          .attr("stroke-width", 3)
          .attr("y1", 0)
          .attr("y2", lineGraphHeight)
          .attr("visibility", "hidden");

        let valueMarker = activeArea.append("circle")
          .attr("id", "valueMarker")
          .attr("fill", "none")
          .attr("stroke", "white")
          .attr("stroke-width", 2)
          .attr("r", 10)
          .attr("visibility", "hidden");

        let label = activeArea.append("text")
          .attr("id", "label")
          .attr("visibility", "hidden");

        let activeRegion = activeArea.append("rect")
          .attr("id", "activeRegion")
          .attr("width", lineGraphWidth)
          .attr("height", lineGraphHeight)
          .attr("fill", "none")
          .attr("pointer-events", "all");

        activeRegion.on('mouseover', function () {
          if (dataDict.length != 0) {
            dropLine.attr('visibility', '');
            label.attr('visibility', '');
            valueMarker.attr("visibility", "");
          }
        });

        activeRegion.on('mouseout', function () {
          dropLine.attr('visibility', 'hidden');
          label.attr('visibility', 'hidden');
          valueMarker.attr("visibility", "hidden");
        });

        let bisect = d3.bisector((d) => d).left;

        // ******* EXTERNAL FUNCTION *****: createDropLine
        // Credit to Prof. Jeff Rzeszotarski, taken from Lecture on September 29, 2021 (INFO 3300). Placed in a separate file and found in /scripts/createDropLine.js
        createDropLine(activeRegion, dropLine, label, valueMarker, bisect, xScaleLine, keys, values, lineGraphWidth, lineGraphHeight)

      }


      function lapTimeLine(circuitData) {
        cId = circuitData.circuitId;
        cName = circuitData.name;
        raceList = racesNcircuits[cId];
        raceLapTimes = [];
        raceList.forEach(rId => {
          const isRidPresent = fastestLaps.find((x) => x.raceId == rId)
          if (isRidPresent) {
            lt = isRidPresent.fastestLapTime;
            year = (races.find((x) => x.raceId == rId)).year;
            raceLapTimes[year] = lt;
          }
        })
        if (raceLapTimes.length > 0) {
          generateLineChart(raceLapTimes);
        }
        else {
          generateLineChart([]);
        }
      }

      // Creating map tooltip (hovering text)
      let mapTooltip = viewport.append("g")
        .attr("id", "mapTooltipG")
        .style("visibility", "hidden")
        .attr("transform", `translate(10, 30)`);
      let mapTooltipText = mapTooltip.append("text")
        .attr("id", "mapTooltipText")
        .style("font-size", "10px")
        .style("text-align", "start")
        .style("fill", "white")
        .raise();

      // Joining dots to show on map as circuit locations
      let circuitDots = viewport.selectAll("circle.circuit")
        .data(circuits)
        .join("circle")
        .attr("class", "circuit")
        .attr("cx", d => projection([d.lng, d.lat])[0])
        .attr("cy", d => projection([d.lng, d.lat])[1])
        .attr("r", "3px")
        .style("fill", "#c70c0c")
        .style("stroke", d => {
          if (d.active === 'True') {
            return 'yellow'
          }
        })
        .on("mouseover", function (event, d) {
          d3.select(this)
            .style("stroke", "white")
            .style("stroke-width", "2px")
          mapTooltip.attr("transform", `translate(${projection([d.lng, d.lat])[0] + 3}, ${projection([d.lng, d.lat])[1] - 5})`)
            .style("visibility", "visible")
          document.getElementById("mapTooltipText").textContent = `${d.name}`;
          mapTooltip.raise();
        })
        .on("mouseout", function (event, d) {
          d3.select(this)
            .style("stroke", d => {
              if (d.active === 'True') {
                return 'yellow'
              } else {
                return 'none'
              }
            })
            .style("stroke-width", "1px")
          document.getElementById("mapTooltipG").style.visibility = "hidden";
          let temp = d3.select(this);
          if (d.active === 'True') {
            return temp.style("stroke", "yellow");
          } else {
            temp.style("stroke-width", "0px");
            return temp.style("stroke", "none");
          }

        })
        .on("click", function (event, d) {
          d3.select(this);
          document.getElementById("lineBlank").textContent = `${d.name}`;
          lapTimeLine(d);
          populateCircuitNote(d);
          populateBarChartNote(d);
          generateBarChart(d);
        });


      // Map zoom
      function zoomTransform({ transform }) {
        viewport.attr("transform", transform.toString());
        circuitDots.attr("r", 5 / transform.k);
        mapTooltipText.style("font-size", 18 / transform.k);

      };
      map.call(zoom);
      zoom.scaleTo(map, 1.4); //set initial zoom

      // Populate the note to the left of the map with information about the current country, circuit name, and flag of that country
      function populateCircuitNote(circuitObject) {
        let countryTemp = circuitObject.country;
        let temp = "";
        nationalityConvert.forEach(n => {
          if (countryTemp === "USA") {
            countryTemp = "United States of America";
          } else if (countryTemp === "UAE") {
            countryTemp = "United Arab Emirates";
          } else if (countryTemp === "Russia") {
            countryTemp = "Russian Federation";
          } else if (countryTemp === "Korea") {
            countryTemp = "Korea (Republic of)"
          }
          if (n.en_short_name === countryTemp) {

            temp = n.alpha_2_code;
          }

        });
        temp = temp.toLowerCase();
        if (temp != "") {
          document.getElementById("teamCountry").setAttribute("src", `images/flags/${temp}.png`);
        }
        if (circuitObject.active === "True") {
          document.getElementById("active-yes").style.visibility = "visible";
          document.getElementById("active-yes").textContent = "This circuit is active for the 2023 season.";
        } else {
          document.getElementById("active-yes").style.visibility = "visible";
          document.getElementById("active-yes").textContent = "This circuit is not currently active."
        }
        document.getElementById("circuitName").textContent = `${circuitObject.name}`;
        document.getElementById("circuitLocation").textContent = `${circuitObject.location}, ${circuitObject.country}`;
      }

      // Populating bar chart note (to the left of bar chart), depending on map item clicked
      function populateBarChartNote(circuitObject) {
        document.getElementById("circuitBlank").textContent = `${circuitObject.name}`;
        document.getElementById("barDescText").textContent = "";
      }

      // Bar chart code
      circuitWins = {}
      winData.forEach(d => {
        circuitId = d.circuitId;
        constructorId = d.constructorId

        if (circuitId in circuitWins) {
          constructors = circuitWins[circuitId]
          if (constructorId in constructors) {
            constructors[constructorId][0] += 1;
          }
          else {
            constructors[constructorId] = [];
            constructors[constructorId][0] = 1;
            constructors[constructorId][1] = d.nameTeam;
          }
          circuitWins[circuitId] = constructors;
        }
        else {
          constructors = {}
          constructors[constructorId] = [];
          constructors[constructorId][0] = 1;
          constructors[constructorId][1] = d.nameTeam;
          circuitWins[circuitId] = constructors;
        }
      });

      let xScaleBar = d3.scaleBand().range([0, barChartWidth]);
      let yScaleBar = d3.scaleLinear().domain([0, 20]).range([barChartHeight, 0]);

      let leftAxisBar = d3.axisLeft(yScaleBar);
      let leftGridlinesBar = d3.axisLeft(yScaleBar)
        .tickSize(-barChartWidth - 10)
        .tickFormat("")
      barChartArea.append("g")
        .attr("class", "yAxisBar y axis")
        .attr("transform", `translate(${barMargins.left},${barMargins.top})`)
        .call(leftAxisBar)
      barChartArea.append("g")
        .attr("class", "yGridBar y gridlines")
        .attr("transform", `translate(${barMargins.left},${barMargins.top})`)
        .call(leftGridlinesBar);

      let bottomAxisBar = d3.axisBottom(xScaleBar);

      barChartArea.append("g")
        .attr('class', 'xAxisBar x-axis')
        .attr('transform', `translate(${barMargins.left},${barChartHeight + barMargins.top})`)
        .call(bottomAxisBar);

      function generateBarChart(circuitObject) {
        circuitData = circuitWins[circuitObject.circuitId];
        var circuitDataKeys = Object.keys(circuitData);

        teams = []
        count = 0;
        circuitDataKeys.forEach(d => {
          if (count < 10) {
            teams.push(circuitData[d][1]);
          }
          count += 1;
        });

        var winCounts = []
        circuitDataKeys.forEach((key) => {
          winCounts.push(circuitData[key][0]);
        });

        xScaleBar.domain(teams);

        barChartArea.selectAll(".xAxisBar").transition()
          .duration(3000)
          .call(bottomAxisBar);

        barChartArea.selectAll(".yAxisBar").transition()
          .duration(3000)
          .call(leftAxisBar);
        barChartArea.selectAll(".yGridBar").transition()
          .duration(3000)
          .call(leftGridlinesBar);

        let barData = [];
        let keyArray = Array.from(teams);
        let valArray = Array.from(winCounts);

        for (let i = 0; i < keyArray.length; i++) {
          dict = {};
          dict["value"] = valArray[i];
          dict["key"] = keyArray[i];
          barData.push(dict);
        }

        barChartArea.selectAll("line.bar").data(barData)
          .join("line")
          .attr("class", "bar")
          .attr("id", d => d.key)
          .attr("x1", d => xScaleBar(d.key) + xScaleBar.bandwidth() / 2 + barMargins.left)
          .attr("x2", d => xScaleBar(d.key) + xScaleBar.bandwidth() / 2 + barMargins.left)
          .attr("y1", barChartHeight + 10)
          .attr("y2", d => yScaleBar(d.value) + 10)
          .style("stroke-width", 40)
          .style("stroke", "#c70c0c");
      }
      // End bar chart code

      // Scatterplot code:

      const yearExtent = [2, 21]  // 2 to 19 are the true values, but need padding
      const winExtent = [1, 105] // 1 to 103 (some drivers have 0 but they wont be included here)

      // Scales for scatterplot axes
      const yearScale = d3.scaleLinear()
        .domain(yearExtent)
        .range([0, scatterWidthA]);
      const winScale = d3.scaleLinear()
        .domain(winExtent)
        .range([scatterHeightA - scatterMargins.top - 4, 0]);

      let leftAxis = d3.axisLeft(winScale);
      scatterArea.append("g")
        .attr("class", "y-axis axis")
        .attr('transform', `translate(${scatterMargins.left},${0})`)
        .call(leftAxis);

      let bottomAxis = d3.axisBottom(yearScale);
      scatterArea.append("g")
        .attr("class", "x-axis axis")
        .attr('transform', `translate(${scatterMargins.left},${scatterHeightA - scatterMargins.top})`)
        .call(bottomAxis);
      //axis label - bottom
      scatterArea.append("text")
        .text("Years Driven")
        .attr("class", "axis-label")
        .attr('transform', `translate(${scatterWidthA / 2},${scatterHeightA + 30})`)
        .style("fill", "white");

      //axis label - left 
      scatterArea.append("text")
        .text("Total Wins")
        .attr("class", "axis-label")
        .attr('transform', `translate(${scatterMargins.left / 2 - 25}, ${scatterHeightA / 2 + 30}) rotate(-90)`)
        .style("fill", "white");

      // Creating tooltip for scatter plot (on hover)
      let tooltip = scatterArea.append("g")
        .attr("id", "tooltipGTag")
        .style("visibility", "hidden")
        .attr("transform", `translate(10, 30)`)
      tooltip.append("text")
        .attr("id", "tooltipText")
        .style("font-size", "13px")
        .style("text-align", "start")
        .style("fill", "white");

      let driverWins = scatterArea.selectAll("circle.scatter")
        .data(winsYears)
        .join("circle")
        .attr("class", "scatter")
        .attr("cx", d => yearScale(d.years) + scatterMargins.left)
        .attr("cy", d => winScale(d.wins))
        .attr("index", d => d.driverRef)
        .attr("r", "4px")
        .on("mouseover", function (event, d) {
          d3.select(this)
            .style("stroke", "white")
            .style("stroke-width", "1px")
          let fNameT = populateDriverNote(d)[0];
          let lNameT = populateDriverNote(d)[1];
          if (d.years > 17) {
            tooltip.attr("transform", `translate(${yearScale(d.years) - 50}, ${winScale(d.wins) - 10})`)
          } else if (d.wins > 100) {
            tooltip.attr("transform", `translate(${yearScale(d.years) + scatterMargins.left}, ${winScale(d.wins) + 20})`)
          }
          else {
            tooltip.attr("transform", `translate(${yearScale(d.years) + scatterMargins.left}, ${winScale(d.wins) - 10})`)
          }
          tooltip.style("visibility", "visible")
          document.getElementById("tooltipText").textContent = `${fNameT} ${lNameT}`;
          tooltip.raise();
        })
        .on("mouseout", function (event, d) {
          tooltip.style("visibility", "hidden")
          d3.select(this)
            .style("stroke", "none")
            .style("stroke-width", "0px");
        })
        .on("click", function (event, d) {
          d3.select(this);
          populateDriverNote(d);
        })
        .style("fill", "#c70c0c");

      // Populating side note next to scatter plot depending on dot hovered over
      function populateDriverNote(driverObject) {
        let driverRefTemp = driverObject.driverRef;
        let fName = "";
        let lName = "";
        let nationality = "";
        driverData.forEach(d => {
          if (d.driverRef === driverRefTemp) {
            fName = d.forename;
            lName = d.surname;
            nationality = d.nationality;
          }
        });
        let flagUrl = "";
        let tempCountry = "";
        nationalityConvert.forEach(n => {
          if (nationality === n.nationality) {
            tempCountry = n.alpha_2_code;
          }
        });
        tempCountry = tempCountry.toLowerCase();

        document.getElementById("driverName").textContent = `${fName} ${lName}`;
        document.getElementById("driverYears").textContent = `${driverObject.years} years`;
        document.getElementById("driverWins").textContent = `${driverObject.wins}`
        if (tempCountry != "") {
          document.getElementById("nationality").setAttribute("src", `images/flags/${tempCountry}.png`);
        }
        return [fName, lName];
      }


    };
    requestData();

    // Scrolling functions to move page down/up on button clicks
    function next1() {
      var area = document.getElementById("barChartArea");
      area.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function next2() {
      var area = document.getElementById("lineChartArea");
      area.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function next3() {
      var area = document.getElementById("scatterArea");
      area.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function topScroll() {
      var area = document.getElementById("car-info");
      area.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  </script>

</body>

</html>