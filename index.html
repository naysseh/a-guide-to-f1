<!DOCTYPE html>
<html>

<head>
  <title>A Guide To F1</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>

  <link rel="stylesheet" type="text/css" href="styles/site.css">
</head>


<body>
  <h1>A Guide to F1</h1>
  <div id="map">
    <div id="mapAnnotations">
      <div id="mapText">What is F1? The fast paced motorsport, <strong>Formula 1</strong>, has been around since 1950. With historical top speeds of around 180 mph in 1950, and current top speeds at around 220 mph, the F1 car is not your average roadster. Cheetahs can run at up to 80 mph; the average car can likely hit 120. F1 cars are the fastest in the world, making the sport high energy, fast paced, and dangerous. 

      <br><br>
      Click on a point to view information about that circuit.
      </div>
      <div id="mapPopup">
        <h3 id="circuitTitle">CIRCUIT INFO:</h3>
        <text id="circuitName"></text>
        <br>
        <text id="circuitLocation"></text>
      </div>
      <button>Scroll down button</button>
    </div>

    <svg id="map" height="900" width="900"></svg>
  </div>
  <svg id="barChart" height="500" width="900"></svg>
  <svg id="lineChart" height="500" width="900"></svg>
  <div id="scatterArea">
    <div id="scatterAnnotations">
      <div id="scatterText">Does length of career correlate with success in F1? Yes, but not necessarily. A few notable drivers such as Lewis Hamilton, Alain Prost, and Ayrton Senna have scored big in their careers, despite none of them having been driving the longest. </div>

      <div id="driverYearStats">placeholder for popup for driver stats on point rollover/click</div>
    </div>
    <svg id="scatter" height="500" width="900"></svg>
  </div>
  

  <script>
    const map = d3.select("svg#map");
    const mapHeight = map.attr("height");
    const mapWidth = map.attr("width");
    let circuitName = d3.select("text#circuitName");
    let circuitLocation = d3.select("text#circuitLocation");

    const barChart = d3.select("svg#barChart");

    const lineChart = d3.select("svg#lineChart");

    const scatter = d3.select("svg#scatter");
    const scatterHeight = scatter.attr("height");
    const scatterWidth = scatter.attr("width");
    const scatterMargins = {top: 15, right: 10, bottom: 20, left: 25};
    let scatterArea = scatter.append("g")
                             .attr('transform',`translate(${scatterMargins.left},${0})`);
    let scatterHeightA = scatterHeight - scatterMargins.top - scatterMargins.bottom;
    let scatterWidthA = scatterWidth - scatterMargins.left - scatterMargins.right;

  /*
    The data files setup (by Natasha) <3 (i figured id put this here so we can go back to it while we work if needed)

    The ones inside the /data folder are all the original, unchanged files. In jupyter though I made some new ones which are in the root directory:

    results_dataset.csv: This is a merge on the initial results csv (it's best to look at it) which has results for lap times, final position, etc., for every race result in the past. The nice part about this set is that it contains the driver values separate from the teams (because many drivers drive for more than 1 team during their lifetime). basically everything is in here you just might have to map/loop on it

    first_place_instances.csv: Is the same as the above one but only has a result if the result was first place (I made this specifically for the scatterplot)

    wins_and_years.csv: total years driven and total wins for a driver
  */  

                             
    const requestData = async function () {
      const combinedData = await d3.csv("results_dataset.csv", d3.autoType);
      console.log("all data", combinedData);

      const atlasData = await d3.json("world-countries.json");
      console.log(atlasData);

      const winsYears = await d3.csv("wins_and_years.csv", d3.autoType);
      console.log("win and years", winsYears);

      // This CSV has all the info about every previous circuit, some of which are not currently active but all should have data from the past [this is literally just the list of circuits, not connected w anything else]
      const circuits = await d3.csv("data/circuits.csv", d3.autoType);
      console.log("circuits", circuits);

      // This CSV has all the info about every previous circuit, some of which are not currently active but all should have data from the past [this is literally just the list of circuits, not connected w anything else]
      const races = await d3.csv("data/races.csv", d3.autoType);
      console.log("races", races);

      const fastestLaps = await d3.csv("races_fastest_times.csv", d3.autoType);
      console.log("fastest laps in race", fastestLaps);

      racesNcircuits = {}
      races.forEach(d => {
        cId = d.circuitId
        rId = d.raceId
        if (!(cId in racesNcircuits)){
          racesNcircuits[cId] = [rId]
        }else if (cId in racesNcircuits){
          raceList = racesNcircuits[cId]
          raceList.indexOf(rId) === -1 ? raceList.push(rId) : console.log("This item already exists");
          racesNcircuits[cId] = raceList
        }
      })
      console.log(racesNcircuits)

      let viewport = map.append("g");
      let countryMesh = topojson.mesh(atlasData, atlasData.objects.countries1);
      let countries = topojson.feature(atlasData, atlasData.objects.countries1);

      var projection = d3.geoMercator().fitSize([mapWidth, mapHeight], countries);
      var path = d3.geoPath().projection(projection);

      viewport.selectAll("path.country")
              .data(countries.features)
              .join("path")
              .attr("class", "country")
              .style("fill", "none")
              .style("stroke", "white")
              .style("stroke-width", ".5px")
              .attr("d", path);

      var zoom = d3.zoom()
                   .scaleExtent([1, 10])
                   .on("zoom", zoomTransform);


     function zoomTransform({transform}) {
       viewport.attr("transform", transform.toString());
     };
     map.call(zoom);
     zoom.scaleTo(map, 1.4); //i set an inital zoom value for it to load on but feel free to change

     function lapTimeLine(circuitData){
      console.log(circuitData);
      cId = circuitData.circuitId
      cName = circuitData.name
      raceList = racesNcircuits[cId]
      console.log(raceList)
      raceLapTimes = []
      raceList.forEach(rId=> {
        const isRidPresent = fastestLaps.find ((x) => x.raceId == rId)
        if (isRidPresent) {
          console.log(isRidPresent)
          lt = isRidPresent.fastestLapTime
          year = (races.find ((x) => x.raceId == rId)).year
          raceLapTimes[year] = lt
        }
        console.log(raceLapTimes)

        // generateLineChart(year, lt)

      })
      fastestLaps
     }

     let circuitDots = viewport.selectAll("circle.circuit")
                               .data(circuits)
                               .join("circle")
                               .attr("class", "circuit")
                               .attr("cx", d => projection([d.lng, d.lat])[0] )
                               .attr("cy", d => projection([d.lng, d.lat])[1] )
                               .attr("r", "3px")
                               .style("fill", "red")
                               .on("click", function (event, d) {
                                lapTimeLine(d)
                               })
                               .on("mouseover", function (event, d) {
                                  d3.select(this)
                                    .style("stroke", "white")
                                    .style("stroke-width", "1px")
                               })
                               .on("mouseout", function (event, d) {
                                  d3.select(this)
                                    .style("stroke", "none")
                                    .style("stroke-width", "0px")
                               })
                               .on("click", function (event, d) {
                                  d3.select(this);
                                  // console.log(this);
                                  populateCircuitNote(d);
                               });

      function populateCircuitNote (circuitObject) {
        document.getElementById("circuitName").textContent = `${circuitObject.name}`;
        document.getElementById("circuitLocation").textContent = `${circuitObject.location}, ${circuitObject.country}`;
      }
      // final chart - scatterplot
      const yearExtent = d3.extent(winsYears, d => d.years); // 1 to 19
      const winExtent = d3.extent(winsYears, d => d.wins); // 1 to 103 (some drivers have 0 but they wont be included here)

      //scales
      const yearScale = d3.scaleLinear()
                          .domain(yearExtent)
                          .range([0, scatterWidthA]);
      const winScale = d3.scaleLinear()
                         .domain(winExtent)
                         .range([scatterHeightA-scatterMargins.top-4, 0]);               
      
      let leftAxis = d3.axisLeft(winScale);    
      scatterArea.append("g")
                 .attr("class", "y-axis axis")
                 .attr('transform',`translate(${scatterMargins.left},${0})`) 
                 .attr("stroke", "white")
                 .call(leftAxis);

      let bottomAxis = d3.axisBottom(yearScale);
      scatterArea.append("g")
                 .attr("class", "x-axis axis")
                 .attr('transform',`translate(${scatterMargins.left},${scatterHeightA - scatterMargins.top})`) 
                 .attr("stroke", "white")
                 .call(bottomAxis);
      //axis label - bottom
      scatterArea.append("text")
                 .text("Years Driven")
                 .attr("class", "axis-label")
                 .attr('transform', `translate(${scatterWidthA / 2},${scatterHeightA + 20})`)
                 .style("fill", "white");

      //axis label - left 
      scatterArea.append("text")
                 .text("Total Wins")
                 .attr("class", "axis-label")
                 .attr('transform', `translate(${scatterMargins.left / 2 - 20}, ${scatterHeightA/2 + 30}) rotate(-90)`)
                 .style("fill", "white");
                  
      let driverWins = scatterArea.selectAll("circle.scatter")
                      .data(winsYears)
                      .join("circle")
                      .attr("class", "scatter")
                      .attr("cx", d => yearScale(d.years) + scatterMargins.left)
                      .attr("cy", d => winScale(d.wins))
                      .attr("index", d => d.driverRef)
                      .attr("r", "4px")
                      .on("mouseover", function (event, d) {
                        console.log(d.driverRef);
                      })
                      .style("fill", "red"); 



    };
    requestData();
  </script>

</body>
</html>